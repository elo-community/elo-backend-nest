import * as dotenv from "dotenv";
import { ethers } from "hardhat";

// í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ (í”„ë¡œì íŠ¸ ë£¨íŠ¸ì˜ .env íŒŒì¼)
dotenv.config({ path: '../../.env' });

async function main() {
    console.log("ğŸš€ Deploying PostLikeSystem to actual network...");

    // í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    const network = process.env.NETWORK || "amoy";
    const adminPrivKey = process.env.ADMIN_PRIV_KEY;
    const rpcUrl = process.env.RPC_AMOY;
    const trivusExpAddress = process.env.TRIVUS_EXP_AMOY;

    if (!adminPrivKey) {
        throw new Error("âŒ ADMIN_PRIV_KEY environment variable is required");
    }

    if (!rpcUrl) {
        throw new Error("âŒ RPC_AMOY environment variable is required");
    }

    if (!trivusExpAddress) {
        throw new Error("âŒ TRIVUS_EXP_AMOY environment variable is required");
    }

    console.log(`ğŸŒ Network: ${network}`);
    console.log(`ğŸ”— RPC URL: ${rpcUrl}`);
    console.log(`ğŸ”‘ Admin Address: ${new ethers.Wallet(adminPrivKey).address}`);
    console.log(`ğŸ¯ TrivusEXP Address: ${trivusExpAddress}`);

    // ë„¤íŠ¸ì›Œí¬ ì—°ê²°
    const provider = new ethers.JsonRpcProvider(rpcUrl);
    const wallet = new ethers.Wallet(adminPrivKey, provider);

    console.log(`\nğŸ“ Step 1: Deploying PostLikeSystem contract...`);

    // PostLikeSystem ì»¨íŠ¸ë™íŠ¸ ë°°í¬
    const PostLikeSystem = await ethers.getContractFactory("PostLikeSystem", wallet);
    const postLikeSystem = await PostLikeSystem.deploy(trivusExpAddress);

    console.log("â³ Waiting for deployment confirmation...");
    await postLikeSystem.waitForDeployment();

    const contractAddress = await postLikeSystem.getAddress();
    console.log(`âœ… PostLikeSystem deployed successfully!`);
    console.log(`ğŸ“ Contract Address: ${contractAddress}`);
    console.log(`ğŸ”— TrivusEXP Token: ${trivusExpAddress}`);
    console.log(`ğŸ‘¤ Owner: ${await postLikeSystem.owner()}`);

    // ì»¨íŠ¸ë™íŠ¸ ê²€ì¦
    console.log(`\nğŸ“Š Contract Verification:`);
    console.log(`- Owner: ${await postLikeSystem.owner()}`);
    console.log(`- Trivus Token Address: ${await postLikeSystem.trivusToken()}`);
    console.log(`- Contract Token Balance: ${ethers.formatEther(await postLikeSystem.getContractTokenBalance())} TRIVUS`);

    // ë°°í¬ ì •ë³´ ì €ì¥
    const deploymentInfo = {
        network,
        contractName: "PostLikeSystem",
        contractAddress,
        trivusExpAddress,
        owner: await postLikeSystem.owner(),
        deploymentTime: new Date().toISOString(),
        rpcUrl,
        gasUsed: await postLikeSystem.deploymentTransaction()?.gasLimit?.toString() || "Unknown"
    };

    console.log(`\nğŸ“‹ Deployment Information:`);
    console.log(JSON.stringify(deploymentInfo, null, 2));

    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ê°€ì´ë“œ
    console.log(`\nğŸ”§ Environment Variables to Add:`);
    console.log(`POST_LIKE_SYSTEM_AMOY=${contractAddress}`);

    // Remixì—ì„œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆëŠ” ì •ë³´
    console.log(`\nğŸ¯ Remix Testing Instructions:`);
    console.log(`1. Remix IDE (https://remix.ethereum.org) ì ‘ì†`);
    console.log(`2. Deploy & Run Transactions íƒ­ ì„ íƒ`);
    console.log(`3. Environment: Injected Provider - MetaMask ì„ íƒ`);
    console.log(`4. MetaMaskì—ì„œ ${network} ë„¤íŠ¸ì›Œí¬ ì—°ê²°`);
    console.log(`5. Contract: PostLikeSystem ì„ íƒ`);
    console.log(`6. At Addressì— ${contractAddress} ì…ë ¥`);
    console.log(`7. Load ë²„íŠ¼ í´ë¦­í•˜ì—¬ ì»¨íŠ¸ë™íŠ¸ ë¡œë“œ`);
    console.log(`8. ê° í•¨ìˆ˜ë“¤ì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”!`);

    console.log(`\nâš ï¸  Important Notes:`);
    console.log(`- ì´ ì£¼ì†Œë“¤ì„ ë°±ì—”ë“œ ì„¤ì •ì— ì¶”ê°€í•˜ì„¸ìš”`);
    console.log(`- ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œë¥¼ ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ì„¸ìš”`);
    console.log(`- í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ì‹¤ì œ ì‚¬ìš©ì„ ì‹œì‘í•˜ì„¸ìš”`);
}

main()
    .then(() => process.exit(0))
    .catch((error) => {
        console.error("âŒ Deployment failed:", error);
        process.exit(1);
    });
